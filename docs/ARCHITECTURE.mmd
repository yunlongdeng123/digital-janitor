%% Digital Janitor - ç³»ç»Ÿæ¶æ„å›¾
%% ä½¿ç”¨ Mermaid è¯­æ³•ç»˜åˆ¶å®Œæ•´æ•°æ®æµ

graph TB
    %% ========== è¾“å…¥å±‚ ==========
    User[ğŸ‘¤ ç”¨æˆ·]
    Inbox[ğŸ“¥ Inbox ç›®å½•<br/>å¾…å¤„ç†æ–‡ä»¶]
    
    %% ========== ç›‘å¬å±‚ ==========
    Watchdog[ğŸ‘€ File Monitor<br/>Watchdog]
    
    %% ========== æ ¸å¿ƒå·¥ä½œæµ ==========
    Router[ğŸ¯ Router<br/>LangGraph çŠ¶æ€æœº]
    
    %% èŠ‚ç‚¹ï¼šæ–‡æœ¬æå–
    ExtractNode[ğŸ“„ Extract Preview Node]
    Cache[(ğŸ’¾ OCR Cache<br/>Redis/File)]
    DirectExtract[ğŸ“ Direct Extract<br/>pypdf]
    OCREngine[ğŸ” OCR Engine]
    RapidOCR[âš¡ RapidOCR<br/>æœ¬åœ°è¯†åˆ«]
    VisionLLM[ğŸ‘ï¸ Vision LLM<br/>å¤šæ¨¡æ€]
    
    %% èŠ‚ç‚¹ï¼šLLM åˆ†æ
    LLMNode[ğŸ§  LLM Analyze Node]
    OpenAI[ğŸ¤– OpenAI API<br/>GPT-4]
    
    %% èŠ‚ç‚¹ï¼šæ„å»ºè®¡åˆ’
    BuildPlanNode[ğŸ“‹ Build Plan Node]
    Memory[(ğŸ§  Memory System<br/>SQLite)]
    PreferenceQuery{ğŸ” Query Preference<br/>Memory Hit?}
    
    %% èŠ‚ç‚¹ï¼šè·¯ç”±å†³ç­–
    RouteDecision{ğŸ”€ Route Decision}
    MemoryRoute[ğŸ§  Memory Route<br/>å­¦ä¹ åˆ°çš„åå¥½]
    DateRoute[ğŸ“… Date Partition<br/>è´¢åŠ¡æ–‡æ¡£]
    SemanticRoute[ğŸ·ï¸ Semantic Route<br/>Vendor/Category]
    
    %% èŠ‚ç‚¹ï¼šæ ¡éªŒ
    ValidateNode[âœ… Validate Node<br/>å®‰å…¨æ£€æŸ¥]
    
    %% èŠ‚ç‚¹ï¼šäººå·¥å®¡æ‰¹
    HITLNode[ğŸ¤ Human Review Node]
    PendingDir[ğŸ“ Pending ç›®å½•<br/>JSON æ–‡ä»¶]
    
    %% ========== UI å±‚ ==========
    WebUI[ğŸŒ Streamlit Web UI]
    Dashboard[ğŸ“ˆ ç»Ÿè®¡çœ‹æ¿]
    ApprovalQueue[ğŸ“‹ å¾…å®¡æ‰¹é˜Ÿåˆ—]
    HistoryPage[ğŸ“œ å®¡æ‰¹å†å²]
    PreferencePage[ğŸ§  åå¥½ç®¡ç†]
    
    %% èŠ‚ç‚¹ï¼šç”¨æˆ·å†³ç­–
    UserDecision{ğŸ‘¤ User Decision}
    
    %% èŠ‚ç‚¹ï¼šæ‰§è¡Œ
    ApplyNode[âœ… Apply Node<br/>æ‰§è¡Œç§»åŠ¨]
    SkipNode[â­ï¸ Skip Node<br/>è·³è¿‡]
    
    %% ========== å­˜å‚¨å±‚ ==========
    Archive[ğŸ“¦ Archive ç›®å½•<br/>å½’æ¡£æ–‡ä»¶]
    Quarantine[ğŸ—‘ï¸ Quarantine ç›®å½•<br/>éš”ç¦»åŒº]
    LogFile[ğŸ“ Logs<br/>JSONL æ—¥å¿—]
    
    %% ========== æ•°æ®æµ ==========
    
    %% 1. æ–‡ä»¶ç›‘å¬æµç¨‹
    User -->|æ‹–å…¥æ–‡ä»¶| Inbox
    Inbox -->|è‡ªåŠ¨æ£€æµ‹| Watchdog
    Watchdog -->|è§¦å‘å¤„ç†| Router
    Inbox -->|æ‰‹åŠ¨æ‰§è¡Œ| Router
    
    %% 2. Router åˆ†å‘
    Router --> ExtractNode
    
    %% 3. æ–‡æœ¬æå–æµç¨‹
    ExtractNode -->|æ£€æŸ¥ç¼“å­˜| Cache
    Cache -->|ç¼“å­˜å‘½ä¸­| ExtractNode
    Cache -->|ç¼“å­˜æœªå‘½ä¸­| DirectExtract
    DirectExtract -->|è´¨é‡åˆ¤æ–­| ExtractNode
    ExtractNode -->|éœ€è¦ OCR| OCREngine
    OCREngine -->|é‡è¦æ–‡æ¡£| VisionLLM
    OCREngine -->|æ™®é€šæ–‡æ¡£| RapidOCR
    VisionLLM -->|ç»“æœ| ExtractNode
    RapidOCR -->|ç»“æœ| ExtractNode
    ExtractNode -->|å†™å…¥ç¼“å­˜| Cache
    
    %% 4. LLM åˆ†æ
    ExtractNode -->|æ–‡æœ¬é¢„è§ˆ| LLMNode
    LLMNode -->|è°ƒç”¨ API| OpenAI
    OpenAI -->|ç»“æ„åŒ–è¾“å‡º| LLMNode
    
    %% 5. æ„å»ºè®¡åˆ’ + Memory æŸ¥è¯¢
    LLMNode -->|åˆ†æç»“æœ| BuildPlanNode
    BuildPlanNode -->|æŸ¥è¯¢åå¥½| PreferenceQuery
    PreferenceQuery -->|è¯»å–| Memory
    
    %% 6. è·¯ç”±å†³ç­–ï¼ˆä¸‰çº§ä¼˜å…ˆçº§ï¼‰
    PreferenceQuery -->|ä¼˜å…ˆçº§1: å‘½ä¸­| MemoryRoute
    PreferenceQuery -->|æœªå‘½ä¸­| RouteDecision
    RouteDecision -->|ä¼˜å…ˆçº§2: è´¢åŠ¡ç±»| DateRoute
    RouteDecision -->|ä¼˜å…ˆçº§3: å…¶ä»–| SemanticRoute
    MemoryRoute --> BuildPlanNode
    DateRoute --> BuildPlanNode
    SemanticRoute --> BuildPlanNode
    
    %% 7. æ ¡éªŒ
    BuildPlanNode -->|é‡å‘½åè®¡åˆ’| ValidateNode
    ValidateNode -->|åˆæ³•| HITLNode
    ValidateNode -->|ä¸åˆæ³•| SkipNode
    
    %% 8. äººå·¥å®¡æ‰¹ï¼ˆéé˜»å¡ï¼‰
    HITLNode -->|ç”Ÿæˆ JSON| PendingDir
    PendingDir -->|è½®è¯¢è¯»å–| WebUI
    
    %% 9. Web UI å±•ç¤º
    WebUI --> Dashboard
    WebUI --> ApprovalQueue
    WebUI --> HistoryPage
    WebUI --> PreferencePage
    ApprovalQueue -->|å±•ç¤ºè¯¦æƒ…| User
    
    %% 10. ç”¨æˆ·å†³ç­–
    User -->|æ‰¹å‡†/ä¿®æ”¹/æ‹’ç»| UserDecision
    UserDecision -->|æ‰¹å‡†| ApplyNode
    UserDecision -->|æ‹’ç»| SkipNode
    
    %% 11. ä¿å­˜å†³ç­–åˆ° Memory
    ApplyNode -->|è®°å½•æ—¥å¿—| Memory
    SkipNode -->|è®°å½•æ—¥å¿—| Memory
    Memory -->|å­¦ä¹ åå¥½| PreferenceQuery
    
    %% 12. æ‰§è¡Œæ–‡ä»¶ç§»åŠ¨
    ApplyNode -->|å®‰å…¨ç§»åŠ¨| Archive
    SkipNode -->|ç§»åŠ¨åˆ°éš”ç¦»åŒº| Quarantine
    
    %% 13. æ—¥å¿—è®°å½•
    ApplyNode -->|å†™å…¥æ—¥å¿—| LogFile
    SkipNode -->|å†™å…¥æ—¥å¿—| LogFile
    
    %% 14. ç»Ÿè®¡æ•°æ®æµ
    Memory -->|æŸ¥è¯¢ç»Ÿè®¡| Dashboard
    LogFile -->|è¯»å–æ—¥å¿—| HistoryPage
    
    %% 15. åå¥½ç®¡ç†
    Memory -->|æŸ¥è¯¢/åˆ é™¤| PreferencePage
    
    %% ========== æ ·å¼ ==========
    classDef inputStyle fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef processStyle fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef storageStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef uiStyle fill:#c8e6c9,stroke:#1b5e20,stroke-width:2px
    classDef decisionStyle fill:#ffccbc,stroke:#bf360c,stroke-width:2px
    
    class User,Inbox inputStyle
    class Watchdog,Router,ExtractNode,LLMNode,BuildPlanNode,ValidateNode,HITLNode,ApplyNode,SkipNode processStyle
    class Cache,Memory,Archive,Quarantine,LogFile,PendingDir storageStyle
    class WebUI,Dashboard,ApprovalQueue,HistoryPage,PreferencePage uiStyle
    class PreferenceQuery,RouteDecision,UserDecision decisionStyle
    
    %% ========== æ³¨é‡Š ==========
    note1[ğŸ’¡ å…³é”®ç‰¹æ€§:<br/>1. OCR ç¼“å­˜åŠ é€Ÿ<br/>2. ä¸‰çº§è·¯ç”±ç­–ç•¥<br/>3. å¢é‡å­¦ä¹ ç®—æ³•<br/>4. éé˜»å¡ HITL]
    
    style note1 fill:#fff3e0,stroke:#e65100,stroke-width:2px,stroke-dasharray: 5 5

